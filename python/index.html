<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Hartree-Fock H2 SCF Demo</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .controls { margin: 20px 0; }
        input[type="range"] { width: 300px; }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
        }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .output-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 5px;
            margin: 10px 0;
        }
        #summary {
            font-family: monospace;
            white-space: pre-wrap;
        }
        #log-output {
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            background: #fff;
            padding: 10px;
            border: 1px solid #ddd;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>üêç Hartree-Fock SCF Demo</h1>

    <div class="controls">
        <label>
            Bond Length (R): <span id="r-value">1.4</span> Bohr
        </label><br>
        <input type="range" id="r-slider" min="0.5" max="2.5" step="0.1" value="1.4">

        <br><br>

        <label>
            Basis Set:
            <select id="basis-select">
                <option value="STO-2G">STO-2G (too small!)</option>
                <option value="STO-3G">STO-3G (minimal)</option>
                <option value="3-21G">3-21G</option>
                <option value="6-31G">6-31G</option>
                <option value="cc-pVDZ">cc-pVDZ (series designed for correlated methods)</option>
                <option value="cc-pVTZ">cc-pVTZ (large - slow!)</option>
                <option value="cc-pVQZ">cc-pVQZ (huge - ridiculous!)</option>
                <option value="def2-SVP">def2-SVP (Alrichs - for DFT)</option>
                <option value="def2-TZVP">def2-TZVP</option>
            </select>
        </label>

        <br><br>

        <button id="run-button" disabled>Loading...</button>
    </div>

    <h3>Results:</h3>
    <div class="output-section">
        <div id="summary">Initializing Pyodide...</div>
    </div>

   <div class="output-section">
       <h4>Overlap Matrix S:</h4>
       <div id="overlap-matrix"></div>
   </div>

   <div class="output-section">
       <h4>SCF Convergence:</h4>
       <div id="scf-convergence"></div>
   </div>

   <div class="output-section">
       <h4>Orbital Energies:</h4>
       <div id="orbital-energies"></div>
   </div>

   <div class="output-section">
       <h4>H‚ÇÇ Potential Energy Surface:</h4>
       <button id="pes-button">Calculate PES Curve</button>
       <div id="pes-curve"></div>
   </div>

        <label>
            <input type="checkbox" id="show-log">
            Show detailed log
        </label>

        <br><br>

    <div id="log-section" class="output-section hidden">
        <h4>Detailed Log:</h4>
        <div id="log-output"></div>
    </div>

    <script>
        let pyodide;

        async function loadPyodideEnvironment() {
            try {
                pyodide = await loadPyodide();
                await pyodide.loadPackage(['numpy', 'micropip']);

                const micropip = pyodide.pyimport('micropip');
                await micropip.install('basis-set-exchange');

                // Load Python modules
                const integrals = await fetch('integrals.py').then(r => r.text());
                const runHf = await fetch('run_HF.py').then(r => r.text());

                pyodide.FS.writeFile('/integrals.py', integrals);
                pyodide.FS.writeFile('/run_HF.py', runHf);

               // Add current directory to Python path so the above can be found
               await pyodide.runPythonAsync(`
               import sys
               if '/' not in sys.path:
                   sys.path.append('/')
               `);

                document.getElementById('summary').textContent = 'Ready! Adjust parameters and click Run SCF.';
                document.getElementById('run-button').textContent = 'Run SCF';
                document.getElementById('run-button').disabled = false;
            } catch (error) {
                document.getElementById('summary').textContent = 'Error loading: ' + error;
            }
        }

        // Plotting functions
        function plotOverlapMatrix(S) {
            const data = [{
                z: S,
                type: 'heatmap',
                colorscale: 'Viridis',
                showscale: true
            }];
            
            const layout = {
                title: 'Overlap Matrix S',
                xaxis: { title: 'Basis function' },
                yaxis: { title: 'Basis function' }
            };
            
            Plotly.newPlot('overlap-matrix', data, layout);
        }

        function plotSCFConvergence(energyHistory) {
            const data = [{
                x: Array.from({length: energyHistory.length}, (_, i) => i + 1),
                y: energyHistory,
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Energy',
                marker: { color: '#4CAF50' }
            }];
            
            const layout = {
                title: 'SCF Convergence',
                xaxis: { title: 'Iteration' },
                yaxis: { title: 'Energy (Ha)' }
            };
            
            Plotly.newPlot('scf-convergence', data, layout);
        }

        function plotOrbitalEnergies(epsilon) {
            const data = [{
                y: epsilon,
                type: 'bar',
                marker: { 
                    color: epsilon.map((e, i) => e < 0 ? 'blue' : 'red')
                }
            }];
            
            const layout = {
                title: 'Molecular Orbital Energies',
                xaxis: { 
                    title: 'Orbital', 
                    tickvals: Array.from({length: epsilon.length}, (_, i) => i),
                    ticktext: epsilon.map((e, i) => e < 0 ? `Occ ${i+1}` : `Virt ${i+1}`)
                },
                yaxis: { title: 'Energy (Ha)' }
            };
            
            Plotly.newPlot('orbital-energies', data, layout);
        }

        async function plotPESCurve() {
            const basis = document.getElementById('basis-select').value;
            const pesButton = document.getElementById('pes-button');
            
            pesButton.disabled = true;
            pesButton.textContent = 'Computing PES...';
            
            const R_values = [];
            const energies = [];
            
            try {
                for (let R = 0.5; R <= 2.5; R += 0.1) {
                    const result = await pyodide.runPythonAsync(`
from run_HF import main
result = main(R=${R.toFixed(1)}, basis_set_name='${basis}')
result
                    `);
                    R_values.push(R);
                    energies.push(result.get('energy'));
                    
                    // Update progress
                    pesButton.textContent = `Computing PES... ${R_values.length}/21`;
                }
                
                const data = [{
                    x: R_values,
                    y: energies,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Energy',
                    marker: { color: '#4CAF50' }
                }];
                
                const layout = {
                    title: 'H‚ÇÇ Potential Energy Surface',
                    xaxis: { title: 'Bond Length (Bohr)' },
                    yaxis: { title: 'Energy (Ha)' }
                };
                
                Plotly.newPlot('pes-curve', data, layout);
                pesButton.textContent = 'Recalculate PES Curve';
                
            } catch (error) {
                document.getElementById('pes-curve').textContent = 'Error: ' + error;
                pesButton.textContent = 'Calculate PES Curve';
            } finally {
                pesButton.disabled = false;
            }
        }

        // Update R value display
        document.getElementById('r-slider').addEventListener('input', (e) => {
            document.getElementById('r-value').textContent = e.target.value;
        });

        // Toggle log visibility
        document.getElementById('show-log').addEventListener('change', (e) => {
            const logSection = document.getElementById('log-section');
            if (e.target.checked) {
                logSection.classList.remove('hidden');
            } else {
                logSection.classList.add('hidden');
            }
        });

        // PES button handler
        document.getElementById('pes-button').addEventListener('click', plotPESCurve);

        // Run SCF calculation
        document.getElementById('run-button').addEventListener('click', async () => {
            const R = parseFloat(document.getElementById('r-slider').value);
            const basis = document.getElementById('basis-select').value;
            const button = document.getElementById('run-button');

            button.disabled = true;
            button.textContent = 'Running...';
            document.getElementById('summary').textContent = 'Running SCF calculation...';

            try {
                const result = await pyodide.runPythonAsync(`
from run_HF import main
result = main(R=${R}, basis_set_name='${basis}')
result
                `);

        // Wasn't reading properly before, convert directly from Python dict entries to JS objects
        const data = result.toJs({dict_converter: Object.fromEntries});
       
        // Debug: Check what we got back
        console.log('Data:', data);
        console.log('S_matrix:', data.S_matrix);
        console.log('energy_history:', data.energy_history);
        console.log('epsilon:', data.epsilon);

                // Display summary results
                const converged = data.converged ? '‚úì' : '‚úó';
                document.getElementById('summary').textContent =
                    `${converged} Converged in ${data.iterations} iterations!\n` +
                    `Final Energy: ${data.energy.toFixed(6)} Ha\n` +
                    `Orbital Energies: [${data.epsilon.map(e => e.toFixed(6)).join(', ')}]`;

                // Display detailed log
                document.getElementById('log-output').textContent = data.log;

          // Create plots
         if (data.S_matrix) {
            console.log('Plotting S matrix...');
            plotOverlapMatrix(data.S_matrix);
        } else {
            console.error('No S_matrix in result');
        }
        
        if (data.energy_history) {
            console.log('Plotting convergence...');
            plotSCFConvergence(data.energy_history);
        } else {
            console.error('No energy_history in result');
        }
        
        if (data.epsilon) {
            console.log('Plotting orbital energies...');
            plotOrbitalEnergies(data.epsilon);
        } else {
            console.error('No epsilon in result');
        }

            } catch (error) {
                document.getElementById('summary').textContent = 'Error: ' + error;
            } finally {
                button.disabled = false;
                button.textContent = 'Run SCF';
            }
        });

        // Initialize on page load
        loadPyodideEnvironment();
    </script>
</body>
</html>
